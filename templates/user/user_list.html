{% extends active_template %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
{% endblock %}

{% block page_title %}{{ 'ユーザー' if user_role == 'admin' else '学生' }}管理{% endblock %}

{% block main_content %}
    <div class="list-card">
        
        <div class="list-header">
            <h2>{{ 'ユーザー' if user_role == 'admin' else '学生' }}管理</h2>
            <p>システムに登録されている{{ 'ユーザー' if user_role == 'admin' else '学生' }}を管理します。</p>
        </div>

        {% set current_role = request.args.get('role', 'all') %}
        <div class="filter-tabs">
            <a href="{{ url_for('user.user_list', role='all') }}" class="filter-tab {{ 'active' if current_role == 'all' else '' }}">すべて</a>
            <a href="{{ url_for('user.user_list', role='student') }}" class="filter-tab {{ 'active' if current_role == 'student' else '' }}">学生</a>   
            {% if user_role == 'admin' %}
            <a href="{{ url_for('user.user_list', role='teacher') }}" class="filter-tab {{ 'active' if current_role == 'teacher' else '' }}">教員</a>
            {% endif %}
        </div>

        <div class="list-actions">
            <form method="get" action="{{ url_for('user.user_search') }}" class="search-form">
                <input
                    type="text"
                    name="keyword"
                    placeholder="名前 または ID"
                    value="{{ request.args.get('keyword', '') }}"
                >
                <button type="submit">検索</button>
            </form>

            {% if user_role == 'admin' %}
                <a href="{{ url_for('user.new_user_form') }}" class="btn-add">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                    新規登録
                </a>
            {% endif %}
        </div>

        <div class="table-responsive">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th width="100">ID</th>
                        <th>氏名</th>
                        <th width="100">区分</th>
                        
                        {# --- カラムヘッダーの動的切り替え (専攻/学科) --- #}
                        <th>専攻 / 学科</th>
                        
                        <th>生年月日</th>
                        
                        <th>性別</th>
                        
                        {% if current_role == 'student' %}
                        <th>学年</th>
                        {% endif %}
                        {% if user_role == 'admin' %}
                        <th width="140">操作</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% if users|length > 0 %}
                        {% for user in users %}
                        <tr>
                            {# --- ID: モデルに合わせて student_id / teacher_id を切り替え --- #}
                            <td style="font-family: monospace;">
                                {{ user.student_id if user.role == 'student' else user.teacher_id }}
                            </td>
                            
                            <td>
                                <div class="user-cell">
                                    <div class="avatar-placeholder">{{ user.name[0] }}</div>
                                    <span class="user-name-text">{{ user.name }}</span>
                                </div>
                            </td>
                            
                            <td>
                                <span class="role-badge {{ 'role-student' if user.role == 'student' else 'role-teacher' }}">
                                    {{ '学生' if user.role == 'student' else '教員' }}
                                </span>
                            </td>
                            
                            {# --- 専攻 / 学科 の表示 --- #}
                            <td>
                                {{ user.department }}
                            </td>
                            
                            {# --- 生年月日 の表示 --- #}
                            <td>
                                <span style="color: #64748b;">{{ user.birth_date }}</span>
                            </td>
                            {# --- 性別 の表示 --- #}
                            <td>
                                <span style="color: #64748b;">{{ user.gender }}</span>
                            </td>
                            
                            {% if current_role == 'student' %}
                            <td>
                                <span style="color: #64748b;">{{ user.grade }}</span>
                            </td>
                            {% endif %}
                            {% if user_role == 'admin' %}
                                <td>
                                    <div class="action-buttons">
                                        {# ID引数を動的に設定 #}
                                        {% set u_id = user.student_id if user.role == 'student' else user.teacher_id %}
                                        
                                        <a href="{{ url_for('user.edit', user_id=u_id) }}" class="action-link edit-link">
                                            編集
                                        </a>
                                        <form method="post"
                                            action="{{ url_for('user.delete_user', user_id=u_id) }}"
                                            style="display:inline;"
                                            onsubmit="return confirm('本当に削除しますか？')">
                                            <button class="action-link delete-link" type="submit">
                                                削除
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                データが見つかりませんでした。
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}