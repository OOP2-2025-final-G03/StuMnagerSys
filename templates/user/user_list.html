{% extends active_template %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
{% endblock %}

{% block page_title %}{{ 'ユーザー' if user_role == 'admin' else '学生' }}管理{% endblock %}

{% block main_content %}
    <div class="list-card">
        
        <div class="list-header">
            <h2>{{ 'ユーザー' if user_role == 'admin' else '学生' }}管理</h2>
            <p>システムに登録されている{{ 'ユーザー' if user_role == 'admin' else '学生' }}を管理します。</p>
        </div>

        {% set current_role = request.args.get('role', 'all') %}
        <div class="filter-tabs">
            {% if user_role == 'admin' %}
            <a href="{{ url_for('user.user_list', role='all') }}" class="filter-tab {{ 'active' if current_role == 'all' else '' }}">すべて</a>
            <a href="{{ url_for('user.user_list', role='student') }}" class="filter-tab {{ 'active' if current_role == 'student' else '' }}">学生</a>   
            <a href="{{ url_for('user.user_list', role='teacher') }}" class="filter-tab {{ 'active' if current_role == 'teacher' else '' }}">教員</a>
            {% endif %}
        </div>

        <div class="list-actions">
            <form method="get" action="{{ url_for('user.user_search') }}" class="search-form">
                <input
                    type="text"
                    name="keyword"
                    placeholder="名前 または ID"
                    value="{{ request.args.get('keyword', '') }}"
                >
                <button type="submit">検索</button>
            </form>

            {% if user_role == 'admin' %}
                <a href="{{ url_for('user.new_user_form') }}" class="btn-add">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"></path></svg>
                    新規登録
                </a>
            {% endif %}
        </div>

        <div class="table-responsive" id="scroll-container">
            <table class="styled-table">
                <thead>
                    <tr>
                        <th width="100">ID</th>
                        <th>氏名</th>
                        <th width="100">区分</th>
                        
                        {# --- カラムヘッダーの動的切り替え (専攻/学科) --- #}
                        <th>専攻 / 学科</th>
                        
                        <th>生年月日</th>
                        
                        <th>性別</th>
                        
                        {% if current_role == 'student' %}
                        <th>学年</th>
                        {% endif %}
                        {% if user_role != 'student' %}
                        <th width="140">操作</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% if users|length > 0 %}
                    <tbody id="user-table-body">
                        {% include 'user/user_rows.html' %}
                    </tbody>
                    {% else %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: #94a3b8;">
                                データが見つかりませんでした。
                            </td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
let offset = 50;
let loading = false;
let hasMore = {{ 'true' if has_more else 'false' }};
const role = "{{ current_role }}";

const container = document.getElementById('scroll-container');
const tbody = document.getElementById('user-table-body');

container.addEventListener('scroll', async () => {
    if (!hasMore || loading) return;

    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 10) {
        loading = true;

        const res = await fetch(
            `{{ url_for('user.user_list') }}?role=${role}&offset=${offset}`,
            { headers: { 'X-Requested-With': 'XMLHttpRequest' } }
        );

        const html = await res.text();

        if (!html.trim()) {
            hasMore = false;
            return;
        }

        tbody.insertAdjacentHTML('beforeend', html);
        offset += 50;
        loading = false;
    }
});
</script>
{% endblock %}