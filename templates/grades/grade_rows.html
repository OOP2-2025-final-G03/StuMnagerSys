{% macro score_to_rank(score) -%}
    {%- if score <= 59 -%}0
    {%- elif score <= 69 -%}1
    {%- elif score <= 79 -%}2
    {%- elif score <= 89 -%}3
    {%- else -%}4
    {%- endif -%}
{%- endmacro %}

{% for g in items %}
<tr>
    {% if not is_student_view %}
        <td style="font-family: monospace;">{{ g.student_id }}</td>
        <td>{{ student_name_map.get(g.student_id, '') }}</td>
    {% endif %}

    {# 科目名（科目ID）表示 #}
    {% set sub_name = subject_map.get(g.subject_id) if subject_map is defined else None %}
    <td>
        {% if sub_name %}
            {{ sub_name }}（{{ g.subject_id }}）
        {% else %}
            {{ g.subject_id }}
        {% endif %}
    </td>

    <td>{{ g.unit }}</td>
    <td>{{ score_to_rank(g.score) }}</td>

    <td>{{ g.score }}</td>

    <td>
        {% set is_pass = (g.score >= 60) %}
        <span class="status-badge {{ 'status-active' if is_pass else 'status-inactive' }}">
            {{ '合格' if is_pass else '不合格' }}
        </span>
    </td>

    {% if not is_student_view %}
    <td>
        <div class="action-buttons">
            <a href="{{ url_for('grade.edit', student_number=g.student_id, subject_id=g.subject_id) }}"
               class="action-link edit-link">
                <svg style="margin-right:4px;" width="14" height="14" fill="none"
                     stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                編集
            </a>

            <a href="{{ url_for('grade.delete', student_number=g.student_id, subject_id=g.subject_id) }}"
               class="action-link delete-link"
               onclick="return confirm('この成績を削除しますか？');">
                <svg style="margin-right:4px;" width="14" height="14" fill="none"
                     stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                削除
            </a>
        </div>
    </td>
    {% endif %}
</tr>
{% endfor %}