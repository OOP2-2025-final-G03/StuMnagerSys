{% extends active_template %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/list.css') }}">
{% endblock %}

{% block page_title %}成績管理{% endblock %}

{% block main_content %}
    <div class="list-card">

        <div class="list-header">
            <h2>{{ title }}</h2>
            <p>{{ '成績を登録します。' if mode == 'create' else '成績を編集します。' }}</p>
        </div>

        <div class="list-actions">
            <a href="{{ url_for('grade.grade_list') }}" class="action-link edit-link">
                一覧に戻る
            </a>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div>
                    {% for category, message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST"
              action="{% if mode == 'edit' and grade is defined %}
                          {{ url_for('grade.edit', student_number=grade.student_id, subject_id=grade.subject_id) }}
                      {% else %}
                          {{ url_for('grade.create') }}
                      {% endif %}">

            <div class="filter-tabs">
                <span class="filter-tab active">
                    {{ '新規登録' if mode == 'create' else '編集' }}
                </span>
            </div>

            <div class="list-actions" style="margin-top: 14px; align-items: stretch;">
                <!-- 学籍番号 -->
                <div class="search-box" style="flex: 1; max-width: none;">
                    {% if mode == 'edit' and grade is defined %}
                        <input type="text"
                               name="student_number"
                               readonly
                               value="{{ grade.student_id }}">
                    {% else %}
                        {% set selected_student = request.form.get('student_number', '') %}
                        <select name="student_number" required style="width:100%; min-height: 38px;">
                            <option value="">学籍番号を選択してください</option>
                            {% for s in students %}
                                <option value="{{ s.student_id }}"
                                        {{ 'selected' if selected_student == s.student_id else '' }}>
                                    {{ s.student_id }}{% if s.name %}（{{ s.name }}）{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>

                <!-- 科目ID -->
                <div class="search-box" style="flex: 1; max-width: none;">
                    <input type="number"
                           name="subject_id"
                           min="0"
                           placeholder="科目ID（例: 12）"
                           {% if mode == 'edit' and grade is defined %}readonly{% endif %}
                           value="{% if grade is defined %}{{ grade.subject_id }}{% else %}{{ request.form.get('subject_id','') }}{% endif %}">
                </div>
            </div>

            <div class="list-actions" style="margin-top: 10px; align-items: stretch;">
                <div class="search-box" style="flex: 1; max-width: none;">
                    <input type="number"
                           name="unit"
                           min="0"
                           placeholder="単位（例: 2）"
                           value="{% if grade is defined %}{{ grade.unit }}{% else %}{{ request.form.get('unit','') }}{% endif %}">
                </div>

                <div class="search-box" style="flex: 1; max-width: none;">
                    <input type="number"
                           name="score"
                           min="0"
                           max="100"
                           placeholder="点数（0〜100）（例: 85）"
                           value="{% if grade is defined %}{{ grade.score }}{% else %}{{ request.form.get('score','') }}{% endif %}">
                </div>

                <button type="submit" class="btn-add">
                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M12 5v14M5 12h14"></path>
                    </svg>
                    {{ '登録' if mode == 'create' else '更新' }}
                </button>
            </div>

        </form>

    </div>
{% endblock %}
