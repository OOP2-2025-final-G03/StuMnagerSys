{% extends active_template %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form.css') }}">
{% endblock %}

{% block page_title %}成績管理{% endblock %}

{% block main_content %}
    <div class="dashboard-card">

        <div class="list-header">
            <h2>{{ title }}</h2>
            <p>{{ '成績を登録します。' if mode == 'create' else '成績を編集します。' }}</p>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div>
                    {% for category, message in messages %}
                        <p>{{ message }}</p>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <form method="POST"
            action="{% if mode == 'edit' and grade is defined %}
                        {{ url_for('grade.edit', student_number=grade.student_id, subject_id=grade.subject_id) }}
                    {% else %}
                        {{ url_for('grade.create') }}
                    {% endif %}">

            <div class="form-grid">

                <div class="form-group">
                    <label>学籍番号</label>
                    {% if mode == 'edit' and grade is defined %}
                        <input type="text"
                            name="student_number"
                            readonly
                            value="{{ grade.student_id }}">
                    {% else %}
                        {% set selected_student = request.args.get('user_id', '') %}
                        <select name="student_number" id="student_select" required>
                            <option value="">学籍番号を選択してください</option>
                            {% for s in students %}
                                <option value="{{ s.student_id }}"
                                        {{ 'selected' if selected_student == (s.student_id|string) else '' }}>
                                    {{ s.student_id }}{% if s.name %}（{{ s.name }}）{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label>科目</label>
                    {% if mode == 'edit' and grade is defined %}
                        <input type="number"
                            name="subject_id"
                            readonly
                            value="{{ grade.subject_id }}">
                    {% else %}
                        {% set selected_subject = request.form.get('subject_id', '') %}
                        <select name="subject_id"
                                id="subject_select"
                                required
                                disabled
                                data-selected="{{ selected_subject }}">
                            <option value="">学籍番号を先に選択してください</option>
                        </select>
                    {% endif %}
                </div>

                <div class="form-group">
                    <label>単位</label>
                    <input type="number"
                        name="unit"
                        id="unit_input"
                        min="0"
                        readonly
                        placeholder="自動入力"
                        value="{% if grade is defined %}{{ grade.unit }}{% else %}{{ request.form.get('unit','') }}{% endif %}">
                </div>

                <div class="form-group">
                    <label>点数 (0〜100)</label>
                    <input type="number"
                        name="score"
                        min="0"
                        max="100"
                        placeholder="例: 85"
                        required
                        value="{% if grade is defined %}{{ grade.score }}{% else %}{{ request.form.get('score','') }}{% endif %}">
                </div>

            </div>

            <button type="submit" class="btn-primary">
                {{ '登録する' if mode == 'create' else '更新する' }}
            </button>

            <div style="text-align: center; margin-top: 24px;">
                <a href="{{ url_for('grade.grade_list') }}" style="color: var(--text-sub); text-decoration: none; font-size: 14px;">
                    キャンセルして一覧に戻る
                </a>
            </div>

        </form>
    </div>

    {% if mode == 'create' %}
    <script src="{{ url_for('static', filename='js/grade.js') }}"></script>
    {% endif %}
{% endblock %}
