{% extends active_template %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/user_list.css') }}" />
<style>
  .form-container { max-width: 720px; margin: 0 auto; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-group.full { grid-column: span 2; }
  .form-group label { font-size: 0.8rem; font-weight: 600; color: var(--text-sub); }
  .form-group input, .form-group select { padding: 10px 14px; border-radius: 8px; border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-main); font-size: 0.875rem; }
  .form-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 32px; }
  .btn-cancel { padding: 10px 18px; border-radius: 8px; text-decoration: none; font-size: 0.875rem; color: var(--text-main); border: 1px solid var(--input-border); }
  .btn-submit { padding: 10px 20px; border-radius: 8px; border: none; background-color: var(--primary-color); color: white; font-weight: 600; cursor: pointer; }
</style>
{% endblock %}

{% block dashboard_content %}
<div class="list-card form-container">
  <div class="list-header">
    <h2>{{ '科目新規登録' if mode == 'create' else '科目編集' }}</h2>
    <p>科目情報を入力してください。</p>
  </div>

  {# ★ここから form タグを開始（一つだけにまとめる） #}
  <form method="post" action="{{ url_for('subject.create', role=role) if mode == 'create' else url_for('subject.edit', subject_id=subject.id, role=role) }}">
    <input type="hidden" name="role" value="{{ role }}">

    <div class="form-grid">
      <div class="form-group full">
        <label>科目名</label>
        <input type="text" name="name" value="{{ subject.name if subject else '' }}" required />
      </div>

      <div class="form-group">
        <label>専攻</label>
        <input type="text" name="major" value="{{ subject.major if subject else '' }}" required />
      </div>

      <div class="form-group">
        <label>単位区分</label>
        <select name="category" required>
          <option value="required" {{ 'selected' if subject and subject.category == 'required' }}>必修</option>
          <option value="elective" {{ 'selected' if subject and subject.category == 'elective' }}>選択</option>
        </select>
      </div>

      <div class="form-group">
        <label>対象学年</label>
        <select name="grades" class="form-control">
          {% set g_val = subject.grade|string if subject else "" %}
          <option value="1" {{ 'selected' if g_val == '1' }}>1年生のみ</option>
          <option value="2" {{ 'selected' if g_val == '2' }}>2年生のみ</option>
          <option value="3" {{ 'selected' if g_val == '3' }}>3年生のみ</option>
          <option value="4" {{ 'selected' if g_val == '4' }}>4年生のみ</option>
          <option value="1,2" {{ 'selected' if g_val == '1,2' }}>1・2年生</option>
          <option value="1,3" {{ 'selected' if g_val == '1,3' }}>1・3年生</option>
          <option value="1,4" {{ 'selected' if g_val == '1,4' }}>1・4年生</option>
          <option value="2,3" {{ 'selected' if g_val == '2,3' }}>2・3年生</option>
          <option value="2,4" {{ 'selected' if g_val == '2,4' }}>2・4年生</option>
          <option value="3,4" {{ 'selected' if g_val == '3,4' }}>3・4年生</option>
          <option value="1,2,3" {{ 'selected' if g_val == '1,2,3' }}>1・2・3年生</option>
          <option value="1,2,4" {{ 'selected' if g_val == '1,2,4' }}>1・2・4年生</option>
          <option value="1,3,4" {{ 'selected' if g_val == '1,3,4' }}>1・3・4年生</option>
          <option value="2,3,4" {{ 'selected' if g_val == '2,3,4' }}>2・3・4年生</option>
          <option value="1,2,3,4" {{ 'selected' if g_val == '1,2,3,4' }}>全学年</option>
        </select>
      </div>

      <div class="form-group">
        <label>単位数</label>
        <input type="number" name="credits" min="1" value="{{ subject.credits if subject else '' }}" required />
      </div>

      <div class="form-group">
        <label>曜日</label>
        <select name="day" required>
          {% for d in ['月','火','水','木','金'] %}
          <option value="{{ d }}" {{ 'selected' if subject and subject.day == d }}>{{ d }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group">
        <label>時間</label>
        <select name="period" required>
          {% for p in range(1, 7) %}
          <option value="{{ p }}" {{ 'selected' if subject and subject.period == p }}>{{ p }}限</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="form-actions">
      <a href="{{ url_for('subject.list', role=role) }}" class="btn-cancel">キャンセル</a>
      <button type="submit" class="btn-submit">{{ '登録' if mode == 'create' else '更新' }}</button>
    </div>
  </form>
</div>
{% endblock %}