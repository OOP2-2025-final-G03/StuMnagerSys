{% extends active_template %}
{% block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/list.css') }}"
/>

<style>
  /* 履修管理ボタン用スタイル追加 */
  .manage-link {
      color: #444aef;
      background-color: transparent;
      border: 1px solid var(--border-light); 
  }

  .manage-link:hover {
      color: #ffffff;
      background-color: #2930f3;
      border-color: #444aef;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(41, 48, 243, 0.2);
  }

</style>
{% endblock %}

{% block page_title %}
{% if user_role in ['admin', 'teacher'] %}全開講科目管理{% else %} 全科目一覧 {% endif %}
{% endblock %} 

{% block main_content %}
<div class="list-card">
  <div class="list-header">
    {% if user_role in ['admin', 'teacher'] %}
    <h2>全開講科目管理</h2>
    <p>開講科目の編集・削除および履修者の管理ができます。</p>
    {% else %}
    <h2>全科目一覧</h2>
    <p>現在開講されている科目の一覧です。</p>
    {% endif %}
  </div>

  {% set current_category = request.args.get('category', 'all') %}
  <div class="filter-tabs">
    <a
      href="{{ url_for('subject.subject_list', category='all') }}"
      class="filter-tab {{ 'active' if current_category == 'all' else '' }}"
      >すべて</a
    >
    <a
      href="{{ url_for('subject.subject_list', category='required') }}"
      class="filter-tab {{ 'active' if current_category == 'required' else '' }}"
      >必修科目</a
    >
    <a
      href="{{ url_for('subject.subject_list', category='elective') }}"
      class="filter-tab {{ 'active' if current_category == 'elective' else '' }}"
      >選択科目</a
    >
  </div>

  <div class="list-actions">
    <form
      method="get"
      action="{{ url_for('subject.subject_list') }}"
      class="search-form"
    >
      <input type="hidden" name="role" value="{{ user_role }}" />
      <input
        type="text"
        name="keyword"
        placeholder="科目名・専攻で検索..."
        value="{{ request.args.get('keyword', '') }}"
      />
      <button type="submit">検索</button>
    </form>
    {% if user_role in ['admin', 'teacher'] %}
    <a href="{{ url_for('subject.create', role=user_role) }}" class="btn-add"
      >新規科目</a
    >
    {% endif %}
  </div>

  <div class="table-responsive" id="scroll-container">
    <table class="styled-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>科目名</th>
          <th>専攻</th>
          <th>区分</th>
          <th>対象学年</th>
          <th>単位数</th>
          <th>開講日時</th>
          {% if user_role in ['admin', 'teacher'] %}
          <th>操作</th>
          {% endif %}
        </tr>
      </thead>
      <tbody id="subject-table-body">
        {% if subjects|length > 0 %}
          {% include 'subject/subject_rows.html' %}
        {% else %}
        <tr>
          <td
            colspan="{{ 8 if user_role in ['admin', 'teacher'] else 7 }}"
            style="text-align: center; padding: 40px; color: #94a3b8"
          >
            データが見つかりませんでした。
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let offset = 50;
let loading = false;
let hasMore = {{ 'true' if has_more else 'false' }};
const category = "{{ current_category }}";
const keyword = "{{ request.args.get('keyword', '') }}";

const container = document.getElementById('scroll-container');
const tbody = document.getElementById('subject-table-body');

container.addEventListener('scroll', async () => {
    if (!hasMore || loading) return;

    if (container.scrollTop + container.clientHeight >= container.scrollHeight - 10) {
        loading = true;

        // クエリパラメータの構築
        const params = new URLSearchParams({
            category: category,
            keyword: keyword,
            offset: offset
        });

        const res = await fetch(
            `{{ url_for('subject.subject_list') }}?${params.toString()}`,
            { headers: { 'X-Requested-With': 'XMLHttpRequest' } }
        );

        const html = await res.text();

        if (!html.trim()) {
            hasMore = false;
            return;
        }

        tbody.insertAdjacentHTML('beforeend', html);
        offset += 50;
        loading = false;
    }
});
</script>
{% endblock %}
